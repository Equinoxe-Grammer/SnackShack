# üèóÔ∏è SnackShop - Arquitectura del Sistema

**üè† Ubicaci√≥n:** `ARCHITECTURE.md`  
**üìÖ √öltima actualizaci√≥n:** 28 de octubre, 2025  
**üéØ Prop√≥sito:** Documentaci√≥n completa de la arquitectura, patrones y dise√±o del sistema

---

## üß≠ Navegaci√≥n

**[üìñ √çndice General](docs/INDEX.md)** | **[üè† README](README.md)** | **[üîå API](API.md)** | **[üóÑÔ∏è Database](DATABASE.md)**

---

## üìã √çndice

- [Visi√≥n General](#-visi√≥n-general)
- [Patr√≥n de Arquitectura](#-patr√≥n-de-arquitectura)
- [Capas del Sistema](#-capas-del-sistema)
- [Flujo de Peticiones](#-flujo-de-peticiones)
- [Componentes Principales](#-componentes-principales)
- [Patrones de Dise√±o](#-patrones-de-dise√±o)
- [Manejo de Dependencias](#-manejo-de-dependencias)
- [Seguridad y Middleware](#-seguridad-y-middleware)
- [Diagramas de Arquitectura](#-diagramas-de-arquitectura)
- [Decisiones de Dise√±o](#-decisiones-de-dise√±o)
- [Puntos de Extensi√≥n](#-puntos-de-extensi√≥n)

---

## üéØ Visi√≥n General

SnackShop implementa una **arquitectura en capas** basada en el patr√≥n **MVC ampliado** con separaci√≥n clara de responsabilidades. El sistema est√° dise√±ado para ser:

- **Mantenible:** Separaci√≥n clara entre l√≥gica de presentaci√≥n, negocio y datos
- **Testeable:** Dependencias inyectables y abstracciones por capas
- **Escalable:** Patrones que permiten extensi√≥n sin modificar c√≥digo existente
- **Seguro:** Middlewares transversales para autenticaci√≥n, autorizaci√≥n y CSRF

### Tecnolog√≠as Base
- **PHP 7.4+** con namespaces PSR-4
- **PDO** para acceso a base de datos
- **Session-based authentication** con roles
- **Sin framework externo** ‚Äî arquitectura custom ligera

---

## üèõÔ∏è Patr√≥n de Arquitectura

### Arquitectura en Capas (Layered Architecture)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   PRESENTATION                      ‚îÇ
‚îÇ  üåê Public/   üé® Views/   üîó Routes/               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                   APPLICATION                       ‚îÇ
‚îÇ  üéÆ Controllers/   üõ°Ô∏è Middleware/                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                    BUSINESS                         ‚îÇ
‚îÇ  üè≠ Services/   üìä Business Logic                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                     DATA                            ‚îÇ
‚îÇ  üóÉÔ∏è Repositories/   üì¶ Models/   üóÑÔ∏è Database/      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Flujo Unidireccional de Dependencias

```
Controllers ‚îÄ‚îÄdepends on‚îÄ‚îÄ> Services ‚îÄ‚îÄdepends on‚îÄ‚îÄ> Repositories
     ‚îÇ                          ‚îÇ                          ‚îÇ
     ‚îÇ                          ‚îÇ                          ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> Views              ‚îî‚îÄ> Business Logic        ‚îî‚îÄ> Models + DB
```

---

## üèóÔ∏è Capas del Sistema

### 1. **Capa de Presentaci√≥n** (`public/`, `src/Views/`)

**Responsabilidad:** Interfaz de usuario y puntos de entrada HTTP

```
public/
‚îú‚îÄ‚îÄ index.php ..................... Entry point principal
‚îú‚îÄ‚îÄ pretty-urls.php ............... URLs amigables (opcional)
‚îú‚îÄ‚îÄ css/ .......................... Estilos del frontend
‚îú‚îÄ‚îÄ js/ ........................... JavaScript del frontend
‚îî‚îÄ‚îÄ assets/ ....................... Im√°genes y recursos est√°ticos

src/Views/
‚îú‚îÄ‚îÄ auth/ ......................... Formularios de login/logout
‚îú‚îÄ‚îÄ dashboard/ .................... Panel de administraci√≥n
‚îú‚îÄ‚îÄ products/ ..................... CRUD de productos
‚îú‚îÄ‚îÄ sales/ ........................ Interfaz de ventas
‚îú‚îÄ‚îÄ users/ ........................ Gesti√≥n de usuarios
‚îî‚îÄ‚îÄ partials/ ..................... Componentes reutilizables
    ‚îú‚îÄ‚îÄ sidebar.php
    ‚îî‚îÄ‚îÄ header.php
```

### 2. **Capa de Aplicaci√≥n** (`src/Controllers/`, `src/Routes/`, `src/Middleware/`)

**Responsabilidad:** Orquestaci√≥n de peticiones HTTP y control de flujo

#### Controllers (üéÆ)
```php
// Ejemplo: ProductController
class ProductController {
    public function index() {
        // 1. Validar autenticaci√≥n (middleware)
        // 2. Obtener datos via Services
        // 3. Preparar datos para la vista
        // 4. Renderizar respuesta
    }
}
```

**Controllers existentes:**
- `AuthController` ‚Äî autenticaci√≥n y sesiones
- `ProductController` ‚Äî CRUD productos
- `VariantController` ‚Äî variantes de productos
- `SalesController` ‚Äî gesti√≥n de ventas
- `DashboardController` ‚Äî panel administrativo
- `HistorialController` ‚Äî historial de transacciones
- `AgregarCajeroController` ‚Äî gesti√≥n de usuarios cajero
- `ApiController` + `Api/CostoController` ‚Äî endpoints JSON

#### Routes (üîó)
```php
// src/Routes/routes.php - Registro centralizado
$router->get('/productos', [ProductController::class, 'index'], [
    AuthMiddleware::class,
    new RoleMiddleware(['admin'])
]);
```

#### Middleware (üõ°Ô∏è)
- **`AuthMiddleware`** ‚Äî verificaci√≥n de sesi√≥n activa
- **`CsrfMiddleware`** ‚Äî protecci√≥n contra CSRF en formularios
- **`RoleMiddleware`** ‚Äî autorizaci√≥n basada en roles (admin/cajero)

### 3. **Capa de Negocio** (`src/Services/`)

**Responsabilidad:** L√≥gica de negocio y reglas de dominio

```php
// Ejemplo: C√°lculo complejo de costos
class CostoService {
    public function costoProductoNeto(int $productId): float {
        // 1. Obtener ingredientes via Repository
        // 2. Aplicar algoritmos de c√°lculo
        // 3. Considerar reglas de negocio
        // 4. Retornar resultado
    }
}
```

**Services existentes:**
- **`ProductService`** ‚Äî l√≥gica de productos y cat√°logo
- **`CostoService`** ‚Äî c√°lculo de costos de producci√≥n
- **`ImpuestosService`** ‚Äî aplicaci√≥n de impuestos y descuentos
- **`SaleService`** ‚Äî procesamiento de ventas
- **`UserService`** ‚Äî gesti√≥n de usuarios
- **`CategoryService`** ‚Äî organizaci√≥n de categor√≠as
- **`PaymentMethodService`** ‚Äî m√©todos de pago
- **`VariantService`** ‚Äî gesti√≥n de variantes
- **`ImageProcessingService`** ‚Äî procesamiento de im√°genes

### 4. **Capa de Datos** (`src/Repositories/`, `src/Models/`, `src/Database/`)

**Responsabilidad:** Persistencia y acceso a datos

#### Repositories (üóÉÔ∏è)
```php
interface ProductRepositoryInterface {
    public function find(int $id): ?Product;
    public function findActiveProducts(): array;
    public function create(array $data): Product;
}

class ProductRepository implements ProductRepositoryInterface {
    // Implementaci√≥n con PDO prepared statements
}
```

#### Models (üì¶)
```php
class Product {
    public int $id;
    public string $name;
    public ?string $description;
    public bool $active;
    public array $variants = [];
    // POPOs simples sin l√≥gica de negocio
}
```

#### Database (üóÑÔ∏è)
- **`Connection`** ‚Äî singleton PDO con configuraci√≥n centralizada
- Soporte MySQL/SQLite via configuraci√≥n
- Manejo de transacciones a nivel de Service

---

## üîÑ Flujo de Peticiones

### 1. **Request HTTP**
```
Usuario ‚îÄ‚îÄHTTP‚îÄ‚îÄ> public/index.php
```

### 2. **Bootstrapping**
```php
// public/index.php
require_once '../vendor/autoload.php';  // Composer PSR-4
session_start();                        // Gesti√≥n de sesiones
require_once '../src/Routes/routes.php'; // Registro de rutas
$router->dispatch($_SERVER['REQUEST_URI'], $_SERVER['REQUEST_METHOD']);
```

### 3. **Resoluci√≥n de Ruta**
```
Router ‚îÄ‚îÄmatching‚îÄ‚îÄ> Route + Middlewares + Controller
```

### 4. **Ejecuci√≥n de Middlewares**
```
AuthMiddleware ‚îÄ‚îÄ> RoleMiddleware ‚îÄ‚îÄ> CsrfMiddleware ‚îÄ‚îÄ> Controller
```

### 5. **Ejecuci√≥n del Controller**
```php
public function index() {
    // Validaciones de entrada
    $service = new ProductService();
    $data = $service->getAllWithVariants();
    
    // Preparar datos para vista
    require_once '../src/Views/products/index.php';
}
```

### 6. **Llamada a Services**
```php
class ProductService {
    public function getAllWithVariants(): array {
        $products = $this->repository->findActiveProducts();
        // L√≥gica de negocio
        return $products;
    }
}
```

### 7. **Acceso a Datos via Repository**
```php
class ProductRepository {
    public function findActiveProducts(): array {
        $stmt = $this->pdo->prepare("SELECT * FROM products WHERE active = 1");
        $stmt->execute();
        return array_map([Product::class, 'fromArray'], $stmt->fetchAll());
    }
}
```

### 8. **Response**
```
View Template ‚îÄ‚îÄHTML‚îÄ‚îÄ> Browser
  o
JSON Response ‚îÄ‚îÄAPI‚îÄ‚îÄ> Client
```

---

## üß© Componentes Principales

### Router (`src/Routes/Router.php`)
- **Prop√≥sito:** Matching de URLs a controllers + middlewares
- **Caracter√≠sticas:** 
  - Soporte para par√°metros en rutas (`/products/{id}`)
  - Registro de middlewares por ruta
  - M√©todos HTTP (GET, POST, PUT, DELETE)

### Service Container
- **Estado actual:** Dependencias manuales en constructores
- **Patr√≥n:** Dependency Injection manual
- **Futuro:** Considerar PSR-11 Container para mayor flexibilidad

### Error Handling
- **Desarrollo:** Errores visibles con detalles
- **Producci√≥n:** P√°ginas de error custom (`src/Views/errors/`)
- **Logs:** Manejo b√°sico de excepciones

### Session Management
- **Autenticaci√≥n:** Session-based con `$_SESSION`
- **Datos almacenados:** `usuario_id`, `usuario`, `rol`
- **Seguridad:** Regeneraci√≥n de session ID en login

---

## üé® Patrones de Dise√±o

### 1. **Repository Pattern**
```php
interface ProductRepositoryInterface {
    public function find(int $id): ?Product;
}

class ProductRepository implements ProductRepositoryInterface {
    // Encapsula acceso a datos
}
```
**Beneficio:** Abstrae la persistencia del negocio

### 2. **Service Layer Pattern**
```php
class SaleService {
    public function processSale(array $items, int $paymentMethod): Sale {
        // Coordinaci√≥n de m√∫ltiples repositories
        // Aplicaci√≥n de reglas de negocio
        // Manejo de transacciones
    }
}
```
**Beneficio:** Centraliza l√≥gica de negocio compleja

### 3. **Front Controller Pattern**
```php
// public/index.php act√∫a como front controller
$router->dispatch($uri, $method);
```
**Beneficio:** Punto √∫nico de entrada para todas las requests

### 4. **Middleware Pattern**
```php
$router->get('/admin', [Controller::class, 'method'], [
    AuthMiddleware::class,
    new RoleMiddleware(['admin'])
]);
```
**Beneficio:** Concerns transversales (auth, logging, etc.)

### 5. **Factory Pattern** (Limitado)
```php
// src/Database/Connection.php
class Connection {
    public static function get(): PDO {
        // Factory para conexiones PDO
    }
}
```

---

## üì¶ Manejo de Dependencias

### Composer (PSR-4)
```json
{
    "autoload": {
        "psr-4": {
            "App\\": "src/"
        }
    }
}
```

### Dependency Injection Manual
```php
class ProductController {
    private ProductService $service;
    
    public function __construct(?ProductService $service = null) {
        $this->service = $service ?? new ProductService();
    }
}
```

### Configuration Management
```php
// src/Config/AppConfig.php
class AppConfig {
    public static function database(): array {
        return [
            'host' => getenv('SNACKSHOP_DB_HOST') ?: '127.0.0.1',
            'name' => getenv('SNACKSHOP_DB_NAME') ?: 'snackshop',
            // Variables de entorno con fallbacks
        ];
    }
}
```

---

## üîí Seguridad y Middleware

### Autenticaci√≥n
```php
class AuthMiddleware {
    public function handle($request, $next) {
        if (!isset($_SESSION['usuario_id'])) {
            header('Location: /login');
            exit;
        }
        return $next($request);
    }
}
```

### Autorizaci√≥n por Roles
```php
class RoleMiddleware {
    private array $allowedRoles;
    
    public function handle($request, $next) {
        if (!in_array($_SESSION['rol'], $this->allowedRoles)) {
            header('Location: /acceso-denegado');
            exit;
        }
        return $next($request);
    }
}
```

### CSRF Protection
```php
class CsrfMiddleware {
    public function handle($request, $next) {
        if ($_SERVER['REQUEST_METHOD'] === 'POST') {
            // Validar token CSRF
        }
        return $next($request);
    }
}
```

---

## üìä Diagramas de Arquitectura

### Diagrama de Componentes
```
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   PUBLIC WEB    ‚îÇ
                    ‚îÇ  (index.php)    ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ     ROUTER      ‚îÇ
                    ‚îÇ  (routes.php)   ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ               ‚îÇ               ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  MIDDLEWARES    ‚îÇ ‚îÇCONTROLLERS‚îÇ ‚îÇ     VIEWS     ‚îÇ
    ‚îÇ Auth‚îÇCSRF‚îÇRole  ‚îÇ ‚îÇProduct‚îÇAPI‚îÇ ‚îÇ Templates‚îÇ404‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ    SERVICES     ‚îÇ
                    ‚îÇCost‚îÇSale‚îÇProduct‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ  REPOSITORIES   ‚îÇ
                    ‚îÇProduct‚îÇUser‚îÇSale‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ               ‚îÇ               ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ     MODELS      ‚îÇ ‚îÇ DATABASE  ‚îÇ ‚îÇ  EXTERNAL     ‚îÇ
    ‚îÇProduct‚îÇUser‚îÇSale‚îÇ ‚îÇConnection ‚îÇ ‚îÇ    APIs       ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Flujo de Datos (Request Lifecycle)
```
HTTP Request ‚îÄ‚îÄ‚ñ∂ public/index.php
                        ‚îÇ
                        ‚ñº
                   Router::dispatch()
                        ‚îÇ
                        ‚ñº
                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                ‚îÇ   MIDDLEWARES   ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ Execute in order
                ‚îÇ 1. Auth         ‚îÇ
                ‚îÇ 2. Role         ‚îÇ
                ‚îÇ 3. CSRF         ‚îÇ
                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ   CONTROLLER    ‚îÇ
              ‚îÇ validate input  ‚îÇ
              ‚îÇ call service    ‚îÇ
              ‚îÇ prepare data    ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
                    ‚ñº
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ    SERVICE      ‚îÇ
            ‚îÇ business logic  ‚îÇ
            ‚îÇ call repository ‚îÇ
            ‚îÇ transform data  ‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ   REPOSITORY    ‚îÇ
          ‚îÇ SQL queries     ‚îÇ
          ‚îÇ PDO operations  ‚îÇ
          ‚îÇ return Models   ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ     MODEL       ‚îÇ
        ‚îÇ data transfer   ‚îÇ
        ‚îÇ simple POPOs    ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ
              ‚ñº
      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚îÇ      VIEW       ‚îÇ
      ‚îÇ render HTML     ‚îÇ
      ‚îÇ or JSON API     ‚îÇ
      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ
            ‚ñº
     HTTP Response ‚îÄ‚îÄ‚ñ∂ Browser/Client
```

---

## üéØ Decisiones de Dise√±o

### ¬øPor qu√© sin Framework?
- **Pros:** Control total, m√≠nimas dependencias, f√°cil debugging
- **Cons:** M√°s c√≥digo boilerplate, menos features out-of-the-box
- **Decisi√≥n:** Adecuado para proyectos peque√±os-medianos con requerimientos espec√≠ficos

### ¬øPor qu√© Session-based Auth?
- **Alternativas:** JWT, OAuth2
- **Decisi√≥n:** Simplicidad para aplicaci√≥n web tradicional
- **Trade-off:** Menos escalable que tokens, pero m√°s simple de implementar

### ¬øPor qu√© Repository Pattern sin ORM?
- **Alternativas:** Active Record, Eloquent, Doctrine
- **Decisi√≥n:** Control directo sobre SQL, performance predecible
- **Trade-off:** M√°s c√≥digo manual, pero mayor flexibilidad

### ¬øPor qu√© estructura de carpetas actual?
```
src/
‚îú‚îÄ‚îÄ Config/      ‚Üê Configuraci√≥n centralizada
‚îú‚îÄ‚îÄ Controllers/ ‚Üê Thin controllers, orquestaci√≥n
‚îú‚îÄ‚îÄ Services/    ‚Üê Fat services, l√≥gica de negocio
‚îú‚îÄ‚îÄ Repositories/‚Üê Data access layer
‚îú‚îÄ‚îÄ Models/      ‚Üê Simple DTOs
‚îú‚îÄ‚îÄ Views/       ‚Üê Presentation layer
‚îú‚îÄ‚îÄ Routes/      ‚Üê Routing configuration
‚îú‚îÄ‚îÄ Middleware/  ‚Üê Cross-cutting concerns
‚îî‚îÄ‚îÄ Database/    ‚Üê DB connection and utilities
```
**Rationale:** Separaci√≥n clara por responsabilidades, f√°cil navegaci√≥n

---

## üîß Puntos de Extensi√≥n

### 1. **A√±adir Nuevos Controllers**
```php
namespace App\Controllers;

class NewController {
    public function index() {
        // Seguir patr√≥n existente
    }
}

// Registrar en routes.php
$router->get('/new-feature', [NewController::class, 'index'], [
    AuthMiddleware::class
]);
```

### 2. **Crear Services Custom**
```php
namespace App\Services;

class CustomService {
    private CustomRepository $repository;
    
    public function __construct(?CustomRepository $repo = null) {
        $this->repository = $repo ?? new CustomRepository();
    }
}
```

### 3. **Implementar Middlewares Adicionales**
```php
namespace App\Middleware;

class LoggingMiddleware {
    public function handle($request, $next) {
        // Log request
        $response = $next($request);
        // Log response
        return $response;
    }
}
```

### 4. **A√±adir APIs JSON**
```php
// En Controller
public function apiMethod() {
    header('Content-Type: application/json');
    $data = $this->service->getData();
    echo json_encode($data);
}
```

### 5. **Integrar Cache**
```php
// Ejemplo de extensi√≥n con cache
class ProductService {
    public function getAllWithVariants(): array {
        $cacheKey = 'products_with_variants';
        
        if ($cached = Cache::get($cacheKey)) {
            return $cached;
        }
        
        $result = $this->repository->findActiveProducts();
        Cache::set($cacheKey, $result, 300); // 5 min
        
        return $result;
    }
}
```

---

## üîó Documentos Relacionados

- **[üìñ √çndice General](docs/INDEX.md)** ‚Äî Navegaci√≥n completa del manual
- **[üîå API Documentation](API.md)** ‚Äî Endpoints y ejemplos de uso
- **[üóÑÔ∏è Database Schema](DATABASE.md)** ‚Äî Esquema y relaciones
- **[üöÄ Deployment Guide](DEPLOYMENT.md)** ‚Äî Despliegue en producci√≥n
- **[üîß Development Setup](DEVELOPMENT.md)** ‚Äî Configuraci√≥n para desarrolladores

---

## üìû Soporte

**¬øTienes preguntas sobre la arquitectura?**
- Crea un issue en [GitHub](https://github.com/Equinoxe-Grammer/SnackShack/issues) con la etiqueta `architecture`
- Consulta la documentaci√≥n espec√≠fica de cada componente en `docs/`

---

**[üìñ √çndice](docs/INDEX.md)** | **[üîå Ver API](API.md)** | **[üóÑÔ∏è Ver Database](DATABASE.md)** | **[üöÄ Ver Deployment](DEPLOYMENT.md)**